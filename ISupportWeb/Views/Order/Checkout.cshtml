@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@model ISupportWeb.Models.BLL.checkoutBLL
@{
    ViewBag.Title = "Checkout";
    Layout = "~/Views/Shared/_Layout.cshtml";

    <link href="~/Content/assets/css/DatePicker/bootstrap-datepicker3.css" rel="stylesheet" />
    <link href="~/Content/assets/css/DatePicker/bootstrap-datepicker3.min.css" rel="stylesheet" />
    <link href="~/Content/assets/css/DatePicker/bootstrap-datepicker3.standalone.css" rel="stylesheet" />
    <link href="~/Content/assets/css/DatePicker/bootstrap-datepicker3.standalone.min.css" rel="stylesheet" />
}
<style>
    .your-order-table table th, .your-order-table table td {
        border-bottom: none !important;
        border-right: medium none;
        font-size: 14px;
        padding: 15px 0;
        text-align: center;
    }

    .coupon-accordion h3 {
        background: #f6f6f6;
        border-top: 3px solid #152b3c;
        color: #515151;
        font-size: 14px;
        font-weight: 400;
        margin: 0 0 30px;
        padding: 1em 2em 1em 3.5em;
        position: relative;
        text-transform: capitalize;
    }

    .btn-place-order {
        background: #152b3c;
        border: medium none;
        color: #ffffff !important;
        font-size: 14px;
        font-weight: 600;
        text-align: center;
        padding: 12px;
        text-transform: uppercase;
        width: 100%;
        -webkit-transition: 0.4s;
        transition: 0.4s;
    }

    .coupon-accordion h3 .coupon {
        color: #152b3c;
        cursor: pointer;
        -webkit-transition: 0.4s;
        transition: 0.4s;
    }
</style>

@*@if (ViewBag.Banner.Count > 0)
{
    <div class="breadcrumb-area section-ptb" style="background: url('@(Configuration["ImageBaseUrl"].ToString() + @ViewBag.Banner[0].Image)'); background-size:cover;">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h2 class="breadcrumb-title">@ViewBag.Banner[0].Title </h2>

                    <ul class="breadcrumb-list">
                        <li class="breadcrumb-item"><a href="~/home/index">Home</a></li>
                        <li class="breadcrumb-item active">Checkout</li>
                    </ul>

                </div>
            </div>
        </div>
    </div>
}
else
{

    <div class="breadcrumb-area section-ptb">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h2 class="breadcrumb-title">Checkout</h2>

                    <ul class="breadcrumb-list">
                        <li class="breadcrumb-item"><a href="~/home/index">Home</a></li>
                        <li class="breadcrumb-item active">Checkout</li>
                    </ul>

                </div>
            </div>
        </div>
    </div>

}*@
<div class="breadcrumb-area section-ptb" style="background: url('@Url.Content("~/content/assets/images/banner/slider-1.png")'); background-size: cover;">
</div>
<!-- main-content-wrap start -->
<div class="main-content-wrap section-ptb checkout-page ">
    <div class="container w-100">
        <div class="row">
            <div class="col">
                <div class="coupon-area">

                    <!-- coupon-accordion start -->
                    <div class="coupon-accordion">
                        <h3><span>Have a coupon?</span> <span class="coupon" id="showcoupon">Click here to enter your code</span></h3>
                        <div class="coupon-content" id="checkout-coupon">
                            <div class="coupon-info">
                                <form action="#">
                                    <p class="checkout-coupon">
                                        <input id="coupon" type="text" placeholder="Coupon code">
                                        <button onclick="CouponDiscount(); return false;" type="submit" class="btn btn-small btn-default ml-2 rounded-0" name="apply_coupon" value="Apply coupon">Apply coupon</button>
                                    <p id="CouponResponse"></p>

                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- coupon-accordion end -->
                </div>
            </div>
        </div>
        <!-- checkout-details-wrapper start -->
        <div class="checkout-details-wrapper">
            <div class="row mb-105">
                <div class="col-lg-6 col-md-5 pt-50 pt-md-0 order-2 order-sm-2 order-md-1">
                    <!-- billing-details-wrap start -->
                    <div class="billing-details-wrap">
                        <form class="was-validated">
                            @* <h3 class="shoping-checkboxt-title pb-1 mb-3">Sender Details</h3>
                            <div class="">
                            <div class="form-row">
                            <div class="form-group col-md-6">
                            <label><span>Sender Name *</span></label>
                            </div>
                            <div class="form-group col-md-6">
                            <label><span>Sender Email *</span></label>
                            </div>
                            <div class="form-group col-md-6">
                            <label><span>Sender Contact *</span></label>
                            </div>
                            <div class="form-group">
                            <label><span class="">Sender Address *</span></label>
                            <input id="SenderAddress" class="form-control" type="text" placeholder="House, Street, unit etc." name="SenderAddress" required>
                            </div>
                            </div>
                            </div> *@
                            <h3 class="shoping-checkboxt-title pb-1 mb-3">Delivery Details</h3>
                            <div class="">
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label><span>Name *</span></label>
                                        <input id="CustomerName" class="form-control" placeholder="Name" type="text" name="CustomerName" required>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label><span>Contact *</span></label>
                                        <input id="ContactNo" class="form-control" placeholder="Contact no." type="text" name="ContactNo" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label><span class="">Address *</span></label>
                                    <input id="Address" class="form-control" type="text" placeholder="House, Street, unit etc." name="Address" required>
                                </div>
                                <div class="form-group">
                                    <label><span class="">Email *</span></label>
                                    <input id="Email" class="form-control" type="text" placeholder="abc@gmail.com" name="Email" required>
                                </div>
                                <div class="form-row">

                                    <div class="form-group col-md-6">
                                        <label><span class="">Place Type *</span></label>
                                        <select id="PlaceType" class="custom-select" required>
                                            <option value="">Select Place Type...</option>
                                            <option>Office</option>
                                            <option>Hospital</option>
                                            <option>House</option>
                                            <option>Apartment</option>
                                            <option>Shop</option>
                                            <option>Outlet</option>
                                            <option>Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label><span class="">Nearest Place </span></label>
                                        <input id="NearestPlace" class="form-control" type="text" placeholder="Park, Bank, Hotel etc." name="NearestPlace">
                                    </div>
                                </div>

                                <div class="order-button-payment">
                                    <a href="javascript:;" id="checkout" class="btn-place-order"><span>Place Order</span></a>
                                    <a href="javascript:;" id="paypal-button" class="btn-block border-0"><span></span></a>
                                    <a class="btn-place-order" id="btn-load">
                                        <span class="spinner-border spinner-border-sm"></span>
                                        Loading..
                                    </a>
                                    <p class="text-danger font-weight-bold text-center bg-category2 rounded mt-3 mb-2" id="payment-alert"></p>
                                    <p class="text-danger font-weight-bold" id="Text-Error"></p>
                                    <p class="text-danger font-weight-bold text-center bg-category2 rounded  " id="paypal-validation"></p>
                                </div>
                            </div>
                        </form>
                    </div>
                    <!-- billing-details-wrap end -->
                </div>
                <div class="col-lg-6 col-md-7 order-1 order-sm-1 order-md-2">
                    <!-- your-order-wrapper start -->
                    <div class="your-order-wrapper">
                        <h3 class="shoping-checkboxt-title pb-1 mb-3">Your Order</h3>
                        <!-- your-order-wrap start-->
                        <div class="your-order-wrap">
                            <!-- your-order-table start -->
                            <div class="your-order-table table-responsive">
                                <table>
                                   @* <thead>
                                        <tr>
                                            <th class="product-name font-weight-bold text-left">Product</th>
                                            <th class="product-total font-weight-bold text-right">Total</th>
                                        </tr>
                                    </thead>*@
                                   @* <tbody class="cart-products">
                                    </tbody>*@

                                    <tfoot>
                                        <tr class="cart-subtotal">
                                            <th class=" text-left">Total Amount (Product/Service)</th>
                                            <td class=" text-right"><span class="amount semi-bold sub-total">BHD 0.000</span></td>
                                        </tr>
                                        <tr class="cart-subtotal">
                                            <th class=" text-left">Products</th>
                                            <td class=" text-right"><span class="amount semi-bold productTotal">BHD 0.000</span></td>
                                        </tr>
                                        <tr class="cart-subtotal" style="border-bottom: 1px solid lightgrey;">
                                            <th class=" text-left">Services</th>
                                            <td class=" text-right"><span class="amount semi-bold serviceTotal ">BHD 0.000</span></td>
                                        </tr>

                                        <tr class="cart-subtotal">
                                            <th class=" text-left">Total Discount (Products/Services)</th>
                                            <td class=" text-right"><span class="amount semi-bold totalDiscount">BHD 0.000</span></td>
                                        </tr>
                                        <tr class="cart-subtotal">
                                            <th class=" text-left">Product Discount</th>
                                            <td class=" text-right"><span class="amount semi-bold productDiscount">BHD 0.000</span></td>
                                        </tr>
                                        <tr class="cart-subtotal" style="border-bottom: 1px solid lightgrey;">
                                            <th class=" text-left">Service Discount</th>
                                            <td class=" text-right"><span class="amount semi-bold serviceDiscount">BHD 0.000</span></td>
                                        </tr>


                                       @* <tr class="cart-subtotal">
                                            <th class=" text-left">Total Taxes</th>
                                            <td class=" text-right"><span class="amount semi-bold Tax-amount">BHD 0.000</span></td>
                                        </tr>*@
                                        <tr class="shipping">
                                            <th class=" text-left"> <span>Total Taxes</span> <span id="taxper"></span></th>
                                            <td class="product-total text-right">
                                                <span class="amount semi-bold Tax-amount"></span>
                                            </td>
                                        </tr>
                                        <tr class="cart-subtotal">
                                            <th class=" text-left">Products</th>
                                            <td class=" text-right"><span class="amount semi-bold productTax">BHD 0.000</span></td>
                                        </tr>
                                        <tr class="cart-subtotal" style="border-bottom: 1px solid lightgrey;">
                                            <th class=" text-left">Services </th>
                                            <td class=" text-right"><span class="amount semi-bold serviceTax">BHD 0.000</span></td>
                                        </tr>

                                        <tr class="shipping" style="border-bottom: 1px solid lightgrey;">
                                            <th class=" text-left">Delivery Charges</th>
                                            <td class="product-total text-right">
                                                <span class="amount semi-bold delivery-charges">BHD. 0.000</span>
                                            </td>
                                        </tr>
                                        @* <tr class="shipping">
                                        <th class=" text-left" id="coupon-text">Coupon Discount</th>
                                        <td class="product-total text-right">
                                        <span class="amount coupon-amount"> BHD 0.000</span>
                                        </td>
                                        </tr>*@

                                       @* <tr class="shipping">
                                            <th class=" text-left"> <span>Tax Percentage</span> <span id="taxper"></span></th>
                                            <td class="product-total text-right">
                                                <span class="amount Tax-amount"></span>
                                            </td>
                                        </tr>*@

                                        <tr class="order-total" style="border-bottom: 1px solid lightgrey;">
                                            <th class=" text-left">Grand Total</th>
                                            <td class=" text-right">
                                                <strong><span id="totalamount" class="amount ">BHD. 0.000</span></strong>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <!-- your-order-table end -->
                            <!-- your-order-wrap end -->
                            <div class="container w-100">
                                <h5 class="text-center m-0 mt-2">Payment Option</h5>
                                <div class="justify-content-center pb-50 pt-4 row">
                                    <div class="btn-group d-flex px-2" role="group" aria-label="Basic example" id="Payment-btn">
                                        <button id="COD" type="button" class="btn btn-pay button-apply-coupon border-0 " onclick="getbuttonvalue(this)" value="COD">

                                            <img style="width:100px;" src="~/Content/assets/images/logo/cod.png" />
                                        </button>
                                        <button id="COD" type="button" class="btn btn-pay button-apply-coupon border-0 " onclick="getbuttonvalue(this)" value="DebitCreditCard">
                                            <img style="width:100px;" src="~/Content/assets/images/logo/visa.png" />
                                        </button>

                                        <button id="COD" type="button" class="btn btn-pay button-apply-coupon border-0 " onclick="getbuttonvalue(this)" value="Banktransfer">

                                            <img style="width:100px;" src="~/Content/assets/images/logo/banktransfer.png" />
                                        </button>

                                    </div>
                                    <br />


                                    <p class="mb-0 mt-10 text-danger px-3 text-center">Invoice will be sent only by email and recipient will not get a printed copy.</p>
                                    <p id="Card-text-cs"></p>
                                </div>
                            </div>

                            <!-- your-order-wrapper start -->
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <!-- checkout-details-wrapper end -->
    </div>
</div>
<!-- main-content-wrap end -->

<input id="CouponID" type="hidden" value="0" />
<input id="CouponCode" type="hidden" value="0" />
<input id="CouponType" type="hidden" value="0" />

@section Scripts {
    <script type="text/JavaScript">
        $(document).ready(function () {
            $("#paraEP").hide();
            $("#paraBT").hide();
            $("#paraJC").hide();
            localStorage.removeItem("_setting");
            localStorage.setItem("_setting", "[]");
            setting();

            $("#paypal-button").hide();
            $("#btn-load").hide();
            var check = getCartLS();
            if (check.length > 0) {
                $("#checkout").show();
            }
            else {
                $("#checkout").hide();
                $("#Text-Error").html("Kindly add items in your cart then place order");
            }
        });
        function getbuttonvalue(val) {
            if (val.value == "PayPal") {
                $("#paypal-button").show();
                $("#checkout").hide();
            }
            else {
                $('#paypal-validation').html("");
                $("#paypal-button").hide();
                $("#checkout").show();
            }

            if (val.value == "Easypaisa") {
                $("#paraBT").hide();
                $("#paraJC").hide();
                $("#paraEP").show();
            }
            else if (val.value == "Banktransfer") {
                $("#paraBT").show();
                $("#paraJC").hide();
                $("#paraEP").hide();
            }
            else if (val.value == "JazzCash") {
                $("#paraBT").hide();
                $("#paraJC").show();
                $("#paraEP").hide();
            }
            else {
                $("#paraEP").hide();
                $("#paraBT").hide();
                $("#paraJC").hide();
            }
        }
        function setting() {
            //get settings
            var chkLSsettings = localStorage.getItem("_setting");
            if (chkLSsettings != null) {
                $.ajax({
                    type: "GET",
                    url: '/Home/GetSetting',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",

                    success: function (data) {
                        var arrTemp = [];
                        arrTemp = getsettingsLS();
                        arrTemp.push({ DeliveryCharges: data.deliveryCharges, ServiceCharges: data.serviceCharges, OtherCharges: data.otherCharges, TaxPercentage: data.taxPercentage, MinimumOrderAmount: data.minimumOrderAmount, ServiceBookingCharges: data.serviceBookingCharges, ConsultancyCharges: data.consultancyCharges, Currency: data.currency, COD: data.cod, PayPal: data.payPal, CardOnDelivery: data.cardOnDelivery, BenefitPay: data.benefitPay, StatusID: data.statusID, CompanyID: data.companyID, DiscountPercentage: data.discountPercentage, IsAppUpdate: data.isAppUpdate });
                        if (data.cod != 1) {
                            $('#COD').addClass('d-none');
                        }

                        if (data.PayPal != 1) {
                            $('#PayPal').addClass('d-none');
                        }
                        if (data.BenefitPay != 1) {
                            $('#BenefitPay').addClass('d-none');
                        }

                        setsettings(arrTemp);
                        cartdata(0);
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        //alert(xhr, textStatus, errorThrown);
                    }
                });
            }
        };
        function setsettings(arr) {

            var settings = localStorage.getItem("_setting");
            if (settings != null) {
                localStorage.setItem("_setting", JSON.stringify(arr));
            }
        };
        function getsettingsLS() {
            var settings = localStorage.getItem("_setting");
            if (settings != null && settings != "")
                return JSON.parse(settings);
            else
                return JSON.parse("[]");
        };

        var currency = localStorage.getItem("currency");
        //checkout();
        $("#checkout").click(function () {
            if ($(".payactive").val() != "PayPal" && $('#Email').val() != "" && $('#Address').val() != "" && $('#ContactNo').val() != "" && $('#CustomerName').val() != "") {
                if ($(".payactive").val() == null) {
                    $('#payment-alert').html('Kindly select payment option');
                }
                else {
                    $('#payment-alert').html('');

                    var Charges = $("#Area").val();
                    checkout();

                }
            }
            else {
            }
        });
        //coupon working
        function CouponDiscount() {
            var coupon = $("#coupon").val();
            $.ajax({
                type: "Get",
                url: '/Order/Coupon?coupon=' + coupon,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function (data) {

                    if (data.data != null) {
                        $("#CouponResponse").removeClass();
                        $("#CouponResponse").html('Coupon Applied').addClass("text-success");
                        if (data.data.Type == 'Amount') {
                            //$(".coupon-amount").html(currency + ' ' + data.data.Amount.toFixed(3));
                            $("#coupon-text").html('Coupon Discount');
                        }
                        else {
                            //$(".coupon-amount").html(currency + ' ' + data.data.Amount.toFixed(3));
                            $("#coupon-text").html('Discount Percentage (' + data.data.Amount.toFixed(0) + '%)');
                        }
                        $('#CouponID').val(data.data.CouponID);
                        $('#CouponCode').val(data.data.CouponCode);
                        $('#CouponType').val(data.data.Type)
                        CouponDis(data.data.CouponID);
                        cartdata(data.data.Amount);
                    }
                    else {
                        $("#CouponResponse").removeClass();
                        $("#CouponResponse").html('Invalid Coupon').addClass("text-danger");
                        $(".coupon-amount").html(currency + ' ' + 0);
                        CouponDis(0);
                        cartdata(0);
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    //
                }
            });
        }
        function CouponDis(ID) {
            return ID;
        }

        $(document).ready(function () {

            $("#Area").change(function () {
                var Charges = this.value;
                var coupon = $("#coupon").val();

                cartdata(coupon, Charges)
            });
        });


        //Order working
        function checkout() {

            $("#checkout").hide();
            $("#btn-load").show();

            //    //=============================== Date For Order# ===================
            

            var TodayDate = new Date();
            var dd = String(TodayDate.getDate()).padStart(2, '0');
            var mm = String(TodayDate.getMonth() + 1).padStart(2, '0');
            var yyyy = (new Date().getFullYear() + '').slice(-2);
            TodayDate = mm + dd + yyyy;
 
            var DeliveryCharges = 0;
            var total = 0;
            var chkLScart = localStorage.getItem("_cartitems");
            var data = JSON.parse(chkLScart);

            var chkLSgift = localStorage.getItem("_giftitems");
            var dataGift = JSON.parse(chkLSgift);
            var totalPrice = 0;
            var totalQty = 0;
            var totalPrice = 0;             
            var totalProduct = 0;
            var totalPqty = 0;
            var totalService = 0;
            var totalSqty = 0;
            var totalDisP = 0;
            var totalDisS = 0;
            var totalDis = 0;
            var productTax = 0;
            var serviceTax = 0;

            for (var i = 0; i < data.length; i++) {
                totalQty += Number(data[i].Qty);
                totalPrice += data[i].Qty * data[i].Price;
            }

            //if (dataGift.length > 0) {
            //    for (var j = 0; j < dataGift.length; j++) {
            //        totalPrice += dataGift[j].DisplayPrice;
            //    }
            //}
            debugger
            for (var i = 0; i < data.length; i++) {
                
                if (data[i].Type == "Item") {
                    if (data[i].DiscountedPrice == 0) {
                        totalPqty += Number(data[i].Qty);
                        totalProduct += data[i].Qty * data[i].Price;

                        $(".productTotal").html(currency + ' ' + (totalProduct).toFixed(3));
                        $(".productDiscount").html(currency + ' ' + (totalDisP).toFixed(3));

                    }
                    else {
                        totalPqty += Number(data[i].Qty);
                        totalProduct += data[i].Qty * data[i].DiscountedPrice;
                        totalDisP += data[i].Price - data[i].DiscountedPrice;



                        $(".productDiscount").html(currency + ' ' + (totalDisP).toFixed(3));
                        $(".productTotal").html(currency + ' ' + (totalProduct).toFixed(3));
                    }
                }
                else {
                    if (data[i].DiscountedPrice == 0) {
                        totalSqty += Number(data[i].Qty);
                        totalService += data[i].Qty * data[i].Price;

                        $(".serviceTotal").html(currency + ' ' + (totalService).toFixed(3));
                    }
                    else {
                        totalSqty += Number(data[i].Qty);
                        totalService += data[i].Qty * data[i].DiscountedPrice;
                        totalDisS += data[i].Price - data[i].DiscountedPrice;
                        $(".serviceDiscount").html(currency + ' ' + (totalDisS).toFixed(3));
                        $(".serviceTotal").html(currency + ' ' + (totalService).toFixed(3));
                    }
                }
                totalDis = totalDisP + totalDisS;
                $(".totalDiscount").html(currency + ' ' + (totalDis).toFixed(3));
            }

            var LSsettings = JSON.parse(localStorage.getItem("_setting"));
            var settings = LSsettings[0];
             
            var CouponDisount = parseFloat($(".coupon-amount").text().replace("BHD.", ""));
           
            Taxamount = (totalPrice * (settings.TaxPercentage / 100));

            
            

            if(totalProduct <= 10){
                DeliveryCharges = settings.DeliveryCharges;
                total = parseFloat((((totalPrice + (totalPrice * (settings.TaxPercentage / 100)))) + parseFloat(DeliveryCharges)));
            }
            else{
                DeliveryCharges = 0;
                total = parseFloat((((totalPrice + (totalPrice * (settings.TaxPercentage / 100)))) + parseFloat(DeliveryCharges)));
            }

            var Order = new Object();
            //Order.OrderNo = 'KF-' + TodayDate + '-' + Convert.ToInt32(Session["CustomerID"])+'-' + Math.floor((Math.random() * 1000) + 1);
            //Order.CustomerID = Convert.ToInt32(Session["CustomerID"]);
            Order.AmountTotal = totalPrice;
            Order.GrandTotal = total;
            Order.Tax = Taxamount;
            Order.ProductTax = productTax;
            Order.ServiceTax = serviceTax;
            Order.ItemsTotal = totalProduct;
            Order.ServicesTotal = totalService;
            Order.DeliveryCharges = DeliveryCharges;
            Order.TotalDiscount = totalDis;
            Order.ServiceDiscount =totalDisS;
             Order.ItemDiscount =totalDisP;
            Order.ItemsQty = totalQty;
            Order.StatusID = 1;
            //Order.OrderDate = dateString;
            //Order.UpdatedDate = dateString;
            Order.UpdatedBy = 0;
            //Order.CouponID = $('#CouponID').val();

            //var value = $("#Area option:selected");

            //========================== Customer Order Info ========================

            Order.Address = $('#Address').val();
            Order.NearestPlace = $('#NearestPlace').val();
            Order.ContactNo = $('#ContactNo').val();
            Order.CustomerName = $('#CustomerName').val();
            Order.Latitude = 'Not Defined';
            Order.Longitude = 'Not Defined';
            //Order.PlaceType = $('#PlaceType').val();
            Order.Email = $('#Email').val();
            Order.OrderDetailString = JSON.stringify(data);
            //Order.CouponCode = $('#CouponCode').val();

            var PaymentType = $(".payactive").val();
            if (PaymentType == "Credimax") {
                Order.PaymentMethodID = 2
            }
            else if (PaymentType == "PayPal") {
                Order.PaymentMethodID = 3
            }
            else if (PaymentType == "JazzCash") {
                Order.PaymentMethodID = 4
            }
            else if (PaymentType == "Easypaisa") {
                Order.PaymentMethodID = 5
            }
            else if (PaymentType == "Banktransfer") {
                Order.PaymentMethodID = 6
            }
            else if (PaymentType == "DebitCreditCard") {
                Order.PaymentMethodID = 7
            }
            else {
                Order.PaymentMethodID = 1
            }

            // =========================================================================

            //var Masterorder = JSON.stringify({ 'data': Order });
            var Masterorder = JSON.parse(JSON.stringify({ 'data': Order }));
            console.log(Masterorder);
            //callService('2', Order);
            $.ajax({
                type: 'POST',
                url: '/Order/PunchOrder',
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8', // when we use .serialize() this generates the data in query string format. this needs the default contentType (default content type is: contentType: 'application/x-www-form-urlencoded; charset=UTF-8') so it is optional, you can remove it
                data: Masterorder,
                success: function (data) {

                    console.log(data);
                    if (data.data.OrderNo == null && data.data != "DebitCreditCard") {
                        localStorage.clear();
                        window.location.href = '/Order/OrderComplete?OrderID=' + data.data + '&OrderNo=' + Order.OrderNo;
                    }
                    else if (data.data == "DebitCreditCard") {
                        localStorage.clear();
                        orderNoURL = Order.OrderNo;
                        Order.OrderID = data.OrderID;

                        //callService('2', Order);
                    }
                    //else if (data.data == "BenefitPay")
                    //{
                    //    localStorage.clear();
                    //    window.location.href = '/Order/BenefitPay?OrderNo=' + Order.OrderNo + '&OrderID=' + data.OrderID + '&GrandTotal=' + Order.GrandTotal;
                    //}
                    else {
                        //getCardDetails(data.data.sessionID, data.data.GrandTotal, data.data.OrderNo, data.data.Description);
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                }
            });


        };


        function getgiftLS() {
            var getgiftItem = localStorage.getItem("_giftitems");
            if (getgiftItem != null && getgiftItem != "")
                return JSON.parse(getgiftItem);
            else
                return JSON.parse("[]");
        }


        function cartdata(coupon, Charges) {
            debugger
            var gifts = getgiftLS();
            var checkLSsetting = localStorage.getItem("_setting");
            var LSsettings = JSON.parse(localStorage.getItem("_setting"));
            var settings = LSsettings[0];

            var shippingcharges = 0;
            var total = 0;
            var chkLScart = localStorage.getItem("_cartitems");
            var data = JSON.parse(chkLScart);
            var html = '';
            var totalPrice = 0;
            var totalQty = 0;
            var totalProduct = 0;
            var totalPqty = 0;
            var totalService = 0;
            var totalSqty = 0;
            var totalDisP = 0;
            var totalDisS = 0;
            var totalDis = 0;
            var productTax = 0;
            var serviceTax = 0;

            for (var i = 0; i < data.length; i++) {
                var giftPrice = 0;
                totalQty += Number(data[i].Qty);
                totalPrice += data[i].Qty * data[i].Price;
                html += '<tr class="cart_item" >'
                    + '<td class="product-name  text-left">' + data[i].Name + '<strong class="product-quantity">' + ' × ' + data[i].Qty + '(' + data[i].Type + ')' + '</strong>'


                html += '</td>'
                    + '<td class="product-total text-right">'
                    + '<span class="amount">' + currency + ' ' + ((data[i].Qty * data[i].Price)).toFixed(3) + '</span>'
                    + '</td>'
                    + '</tr>'

                if (data[i].Type == "Item") {
                    if (data[i].DiscountedPrice == 0) {
                        totalPqty += Number(data[i].Qty);
                        totalProduct += data[i].Qty * data[i].Price;

                        $(".productTotal").html(currency + ' ' + (totalProduct).toFixed(3));
                        $(".productDiscount").html(currency + ' ' + (totalDisP).toFixed(3));

                    }
                    else {
                        totalPqty += Number(data[i].Qty);
                        totalProduct += data[i].Qty * data[i].DiscountedPrice;
                        totalDisP += data[i].Price - data[i].DiscountedPrice;



                        $(".productDiscount").html(currency + ' ' + (totalDisP).toFixed(3));
                        $(".productTotal").html(currency + ' ' + (totalProduct).toFixed(3));
                    }
                }
                else {
                    if (data[i].DiscountedPrice == 0) {
                        totalSqty += Number(data[i].Qty);
                        totalService += data[i].Qty * data[i].Price;

                        $(".serviceTotal").html(currency + ' ' + (totalService).toFixed(3));
                    }
                    else {
                        totalSqty += Number(data[i].Qty);
                        totalService += data[i].Qty * data[i].DiscountedPrice;
                        totalDisS += data[i].Price - data[i].DiscountedPrice;
                        $(".serviceDiscount").html(currency + ' ' + (totalDisS).toFixed(3));
                        $(".serviceTotal").html(currency + ' ' + (totalService).toFixed(3));
                    }
                }
                totalDis = totalDisP + totalDisS;
                $(".totalDiscount").html(currency + ' ' + (totalDis).toFixed(3));
            }
            //$(".cart-products").html(html)


        @*if (totalPrice <= 0) {change max amount delivery amount
            if (data.length > 0) {
            shippingcharges = 0;change value for delivery charges
            $(".shipping-amount").html(currency + ' ' + settings.DeliveryCharges.toFixed(3));
            }
            else {
            $(".shipping-amount").html(current + ' ' + settings.DeliveryCharges.toFixed(3));
            }
            }
            else {
            shippingcharges = 0;
            $(".shipping-amount").html(settings.DeliveryCharges.toFixed(3));
            }*@
                            if (data.length > 0) {
                if (settings.TaxPercentage != null && settings.TaxPercentage) 
                {
                    productTax = totalProduct * settings.TaxPercentage / 100;
                    serviceTax = totalService * settings.TaxPercentage / 100;
                    $(".productTax").html(currency + ' ' + (productTax).toFixed(3));
                    $(".serviceTax").html(currency + ' ' + (serviceTax).toFixed(3));
                }
                else{
                    $(".productTax").html(currency + ' ' + 0.000);
                    $(".serviceTax").html(currency + ' ' + 0.000);
                }

                if(totalProduct <= 10)
                {
                    $('.delivery-charges').html(currency + ' ' + settings.DeliveryCharges.toFixed(3));
                }
                else{
                    $('.delivery-charges').html(currency + ' ' + 0.000);
                }
                

                $(".sub-total").html(currency + ' ' + (totalPrice).toFixed(3));

                //$(".shipping-amount").html(currency + ' ' + settings.DeliveryCharges.toFixed(3));
                //Delivery = Charges;

                



                Taxamount = (totalPrice * (settings.TaxPercentage / 100)).toFixed(3);
                $('.Tax-amount').html(currency + ' ' + Taxamount);
                $('#taxper').html(' (' + settings.TaxPercentage + '%)');
                if ($('#CouponType').val() == 'Amount') {
                    total = parseFloat((((totalPrice + (totalPrice * (settings.TaxPercentage / 100))) - coupon) + parseFloat(Delivery))).toFixed(3);
                    $(".coupon-amount").html(currency + ' ' + coupon.toFixed(3));
                }
                else {
                    total = parseFloat((((totalPrice + (totalPrice * (settings.TaxPercentage / 100))) - (totalPrice * (coupon / 100))) + parseFloat(settings.DeliveryCharges))).toFixed(3);
                    $(".coupon-amount").html(currency + ' ' + (totalPrice * (coupon / 100)).toFixed(3));
                }

                $("#totalamount").html(currency + ' ' + total);
            }
            else {
                $(".sub-total").html("");
                $('.Tax-amount').html("");
                $(".delivery-charges").html("");
                $("#totalamount").html("");
            }


            if (total < settings.minimumOrderAmount && total > 0) {
                $("#checkout").hide();
                $("#Text-Error").html("Minimum Order Value is RS " + settings.minimumOrderAmount.toFixed(3) + ". Please get some more product to proceed your order.");
            }
            else if (total > settings.minimumOrderAmount) {
                $("#checkout").show();
            }
        };
        var header = document.getElementById("Payment-btn");
        var btns = header.getElementsByClassName("btn");

        $('#Payment-btn').on('click', '.btn-pay', function () {
            $(this).addClass('payactive').siblings().removeClass('payactive');
            $('#payment-alert').html('');
        });

        @*for (var i = 0; i < btns.length; i++) {
        btns[i].addEventListener("click", function () {
        var current = document.getElementsByClassName("payactive");
        current[0].className = current[0].className.replace(" payactive", "");
        this.className += " payactive";
        });
        }*@

            function callService(tran_Type, order) {

                var data = getData(tran_Type, order);
                $('.loader').css('display', 'initial');
                $('#overlay').css('display', 'initial');
                $.ajax({
                    url: '@Url.Action("Direct_Transfer", "Order")',
                    headers: { "Accept": "application/json" },
                    type: 'POST',
                    data: data,
                    success: function (vdata) {

                        if (vdata.length > 0) {
                            vdata = JSON.parse(vdata);
                        }
                        if (vdata.IsSuccess) {

                            var sessionID = vdata.Data.SESSION_ID;
                            window.location.href = 'https://digitalbankingportal.hbl.com/hostedcheckout/Site/index.html#/checkout?data=' + sessionID;

                        }
                        else {
                            console.log(vdata);
                            $('.loader').css('display', 'none');
                            $('#overlay').css('display', 'none');
                            alert(JSON.stringify(vdata));
                        }
                    },
                    error: function (request, error) {
                        $('.loader').css('display', 'none');
                        $('#overlay').css('display', 'none');
                        alert('Failed To Connect To Server !!');
                    }
                });
            }
        function getData(tran_type, order) {

            //var arr = [];
            //var od = order.orderta;
            //for (var i = 0; i < od.length; i++) {
            //    arr.push({ "ITEM_NAME": od[i].name, "QUANTITY": od[i].sads })
            //}
            //order.GrandTotal

            var data = {

                "SHIPPING_DETAIL": {
                    "NAME": order.SenderName,
                    "DELIEVERY_DAYS": "0",
                    "SHIPPING_COST": "0",
                },
                "ORDER": {
                    "DISCOUNT_ON_TOTAL": "0",
                    "SUBTOTAL": order.GrandTotal.toString(),
                    "OrderSummaryDescription": [
                        {
                            "ITEM_NAME": "NA",
                            "QUANTITY": "1",
                            "UNIT_PRICE": "1",
                            "OLD_PRICE": "1",
                            "CATEGORY": "0",
                            "SUB_CATEGORY": "0"
                        }
                    ]
                },
                "ADDITIONAL_DATA": {
                    "PAYMENT_TOKEN": "",
                    "CURRENCY": "PKR",
                    "REFERENCE_NUMBER": order.OrderID.toString(),
                    "BILL_TO_FORENAME": order.SenderName,
                    "BILL_TO_SURNAME": "NA",
                    "BILL_TO_EMAIL": order.SenderEmail,
                    "BILL_TO_PHONE": "000000000",
                    "BILL_TO_ADDRESS_LINE": "KHI PAK",
                    "BILL_TO_ADDRESS_CITY": "KHI",
                    "BILL_TO_ADDRESS_STATE": "SD",
                    "BILL_TO_ADDRESS_COUNTRY": "PK",
                    "BILL_TO_ADDRESS_POSTAL_CODE": "75300",

                    "SHIP_TO_FORENAME": order.CustomerName,
                    "SHIP_TO_SURNAME": "NA",
                    "SHIP_TO_EMAIL": order.SenderEmail,
                    "SHIP_TO_PHONE": "00000000",
                    "SHIP_TO_ADDRESS_LINE": "khi pak",
                    "SHIP_TO_ADDRESS_CITY": "Karachi",
                    "SHIP_TO_ADDRESS_STATE": "SD",
                    "SHIP_TO_ADDRESS_COUNTRY": "PK",
                    "SHIP_TO_ADDRESS_POSTAL_CODE": "75300",
                    "MerchantFields": {
                        "MDD1": "WC",
                        "MDD2": "Yes",
                        "MDD3": "Online flower shop",
                        "MDD4": "KarachiFlora",
                        "MDD5": "No",
                        "MDD6": "Standard",
                        "MDD7": "0",
                        "MDD8": "Pakistan",
                        "MDD9": "",
                        "MDD10": "",
                        "MDD11": "",
                        "MDD12": "",
                        "MDD13": "",
                        "MDD14": "",
                        "MDD15": "",
                        "MDD16": "",
                        "MDD17": "",
                        "MDD18": "",
                        "MDD19": "",
                        "MDD20": "NO"
                    }
                },

                "USER_ID": 'karachifloraadmin',
                "PASSWORD": 'EMEGx@p3@f',
                "CHANNEL": 'HBLPay_Karachiflora_Website',
                "RETURN_URL": 'https://www.karachiflora.com/Order/HBLPaymentApproved',
                "CANCEL_URL": 'https://www.karachiflora.com/Order/HBLPaymentApproved',
                "TYPE_ID": "0"
            };
            return data;
        }
    </script>


    <script src="~/Content/assets/js/plugins/bootstrap-datepicker.min.js"></script>
    <script src="~/Content/assets/js/plugins/bootstrap-datepicker.js"></script>
    <script>
        $("#DeliveryDate").on("change", function () {
            if ($(this).val() != null || $(this).val() != '') {
                $("#DeliveryDate").css('border', '1px solid green');
            }

        });
        $(document).ready(function () {
            $("#DeliveryDate").css('border', '1px solid red');
            var dt = new Date();
            var time = dt.getHours();

            if (time > 20) {
                $('#DeliveryDate').datepicker({
                    startDate: '@DateTime.Today.AddDays(1).ToString("MM/dd/yyyy").ToString()',
                    endDate: '@DateTime.Today.AddDays(40).ToString("MM/dd/yyyy").ToString()',
                    autoclose: true,
                    toggleActive: true
                });
            }
            else {
                $('#DeliveryDate').datepicker({
                    startDate: '@DateTime.Today.AddDays(0).ToString("MM/dd/yyyy").ToString()',
                    endDate: '@DateTime.Today.AddDays(40).ToString("MM/dd/yyyy").ToString()',
                    autoclose: true,
                    todayHighlight: true,
                    toggleActive: true
                });
            }

        });


    </script>

}
